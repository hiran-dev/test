{% comment %} <!-- /snippets/product-grid-item-variant.liquid -->

{% comment %}
  A grid item for products used in collection grid view

  * product {object} - The current prodcut

  {% render 'product-grid-item', product: product %}
{% endcomment %}

{%- liquid

assign on_sale = false
if product.compare_at_price > product.price
  assign on_sale = true
endif

assign sold_out = true
if product.available
  assign sold_out = false
endif

# Siblings are a collection metafield called theme.siblings
assign sibs_collection = nil
assign has_siblings = false
if settings.show_siblings and product.metafields.theme.siblings.value != blank and product.metafields.theme.siblings.type == 'single_line_text_field'
  assign sibs_collection = collections[product.metafields.theme.siblings.value]
  # Ensure the collection was set up to contain this product
  for sib_product in sibs_collection.products
    if sib_product == product
      assign has_siblings = true
    endif
  endfor
endif

assign swatch_option = nil
assign has_swatches = false
assign swatch_limit = settings.card_swatch_limit

if settings.swatches_enable and settings.swatches_collection_enable
  # Detect new swatch system
  for option in product.options_with_values
    if option.values.first.swatch != null
      assign has_swatches = true
      assign swatch_option = option
      break
    endif
  endfor

  if has_swatches == false
    # Detect old swatch system
    assign swatch_translation = 'general.swatches.color' | t
    assign swatch_labels = swatch_translation | append: ',' | split: ','
    for label in swatch_labels
      assign sanitized_label = label | lstrip | rstrip
      if product.options_by_name[sanitized_label].values.size > 0
        assign has_swatches = true
        assign swatch_option = product.options_by_name[sanitized_label]
        break
      endif
    endfor
  endif
endif

# A button that will add to cart immediately: product with only one default variant or a product with color swatches and no other variants
assign instant_add_button = nil

if settings.instant_add_enable
  if product.variants.size == 1
    assign instant_add_button = true
  elsif has_swatches and product.options.size == 1
    assign instant_add_button = true
  endif
endif

# A quick add button that will show short variants like 'size' inside the button.
assign inline_variant_buttons = nil

# Get the non color option
# swatch_option.position -> 1 is off by one, it means product.options[0]
# In case of siblings, the inline option buttons always use the first option
if settings.instant_add_enable
  if product.options.size == 1
    assign inline_variant_buttons = product.options_with_values[0]
  elsif has_swatches and product.options.size == 2
    if swatch_option.position == 1
      assign inline_variant_buttons = product.options_with_values[1]
    else
      assign inline_variant_buttons = product.options_with_values[0]
    endif
  endif
endif


# Capture the swatch link markup so we only have filter product.variants by color one time
assign swatch_link_markup = ''

# Pass pre-filtered color variants into content, because the logic needs to know about
# swatch option positions and swatches need to use the where filter to get the list
assign inline_variants = nil

# Placeholder to be displayed when no product image
assign placeholder = placeholder | default: false
-%}

<product-grid-item
  aria-label="{{ product.title | strip_html | escape }}"
  class="product-grid-item group/product-grid-item"
  data-item-id="{{ product.id }}"
  {{ attributes }}
>
  {% if has_siblings and sibs_collection.products.size > 0 %}
    {%- liquid
      # Initialize an empty array to hold visible siblings (i.e. ones under swatch limit)
      assign visible_siblings = "" | split: ","

      # Initial visible sibling count is 1 to account for the current product
      assign visible_sibling_count = 1

      # Loop through siblings collection and add the current product, plus other siblings until we hit the swatch_limit
      for sibling in sibs_collection.products
        if sibling.id == product.id or visible_sibling_count < swatch_limit
          # Create a new array with the current value, then concat it into the main array
          assign new_array = sibling | sort
          assign visible_siblings = visible_siblings | concat: new_array

          unless sibling.id == product.id
            assign visible_sibling_count = visible_sibling_count | plus: 1
          endunless
        endif
      endfor
    -%}

    {%- for sib_product in visible_siblings -%}
      {% liquid
        assign visible = false
        assign first_sibling_variant = sib_product.variants[0]
        if sib_product.id == product.id
          assign visible = true
        endif

        if visible and preload
          assign preload_variant = true
        endif
        if visible and eagerload
          assign eagerload_variant = true
        endif

        assign inline_variant_buttons = nil
        if settings.instant_add_enable and sib_product.options.size == 1
          assign inline_variant_buttons = sib_product.options_with_values[0]
        endif

        if inline_variant_buttons
          assign inline_variants = sib_product.variants
        endif
      -%}

      {% render 'product-grid-item-variant',
        product: sib_product,
        variant: first_sibling_variant,
        badge_string: badge_string,
        visible: visible,
        instant_add_button: instant_add_button,
        inline_variant_buttons: inline_variant_buttons,
        inline_variants: inline_variants,
        section_width: section_width,
        eagerload: eagerload_variant,
        preload: preload_variant,
        placeholder: placeholder,
        columns_desktop: columns_desktop,
        columns_tablet: columns_tablet,
        columns_mobile: columns_mobile
      %}
    {% endfor %}
  {% elsif has_swatches %}
    {%- liquid

      # Note: this is a hack based on options having a property named option1, option2, or option3 -- which we rely on below to filter the variants array
      assign swatch_position_key = 'option' | append: swatch_option.position
      assign selected_swatch_value = swatch_option.selected_value

      # Initialize an empty array to hold visible siblings (i.e. ones under swatch limit)
      assign visible_swatches = "" | split: ","

      # If there is a selected swatch, start the visible swatch count at 1 to account for it
      if selected_swatch_value != blank
        assign visible_swatch_count = 1
      else
        assign visible_swatch_count = 0
      endif

      # Loop through siblings collection and add the current product, plus other swatches until we hit the swatch limit
      for swatch_value in swatch_option.values
        if swatch_value == selected_swatch_value or visible_swatch_count < swatch_limit
          # Create a new array with the current value, then concat it into the main array
          assign new_array = swatch_value | sort
          assign visible_swatches = visible_swatches | concat: new_array

          unless swatch_value == selected_swatch_value
            assign visible_swatch_count = visible_swatch_count | plus: 1
          endunless
        endif
      endfor
    -%}

    {%- for swatch_value in visible_swatches -%}
      {% liquid

        # Limit S|M|L to low-variant products to ensure collection page performance
        if product.variants.size < 200
          assign this_color_variants = product.variants | where: swatch_position_key, swatch_value
          assign in_stock_options = this_color_variants | where: 'available'
          if inline_variant_buttons
            assign inline_variants = this_color_variants
          endif
        else
         # Fall back to quickview with section-rendering API variant selection if there's too many variants
         assign inline_variant_buttons = false
         assign inline_variants = nil
        endif


        # Use the default variant for the swatch value. If that variant has media attached the image will change.
        # If not, the variant image will not change when swatch is selected.
        assign current_variant = swatch_value.variant

        # If the variant is blank, use the first variant in the color variants
        if current_variant == blank
          assign current_variant = this_color_variants | first
        endif

        # If there is a variant selected from filters, show that variant first
        assign visible = false
        if product.selected_variant != blank
          if product.selected_variant.id == current_variant.id
            assign visible = true
          endif
        elsif forloop.first
          assign visible = true
        endif

        if visible and preload
          assign preload_variant = true
        endif
        if visible and eagerload
          assign eagerload_variant = true
        endif
      -%}

      {% render 'product-grid-item-variant',
        product: product,
        variant: current_variant,
        badge_string: badge_string,
        visible: visible,
        instant_add_button: instant_add_button,
        inline_variant_buttons: inline_variant_buttons,
        inline_variants: inline_variants,
        section_width: section_width,
        swatch_option: swatch_option,
        eagerload: eagerload_variant,
        preload: preload_variant,
        placeholder: placeholder,
        columns_desktop: columns_desktop,
        columns_tablet: columns_tablet,
        columns_mobile: columns_mobile
      %}

      {% capture swatch_link_markup %}
        {{ swatch_link_markup }}
        <radio-swatch title="{{ swatch_value.name }}" class="swatch__button{% if in_stock_options.size == 0 %} sold-out{% endif %}{% if settings.swatches_squares %} swatch__button--square{% endif %}">
          <a
            href="{{ current_variant.url }}"
            class="swatch__label"
            {% if swatch_value.swatch != null %}
              data-swatch
              style="--swatch: {{ swatch_value.swatch.color }}"
            {% else %}
              data-swatch="{{ swatch_value | escape_once }}"
            {% endif %}

            data-grid-item-variant="{{ current_variant.id }}"
            data-swatch-index="{{ forloop.index0 }}"

            {% if visible %}aria-current="true"{%- endif -%}
            {% if current_variant.featured_media %}
              data-swatch-image="{{ current_variant.featured_media.preview_image.src }}"
            {% endif %}

            {% if current_variant.featured_media %}
              data-swatch-image-id="{{ current_variant.featured_media.id }}"
            {% endif %}
          >
            {% if swatch_value.swatch.image %}
              {% render 'image', img_object: swatch_value.swatch.image, width: 34, wh_ratio: 1 %}
            {% endif %}
            <span class="visually-hidden">{{ swatch_value }}</span>
          </a>
        </radio-swatch>
      {% endcapture %}
    {% endfor %}
  {% else %}

    {%- liquid

      # Limit S|M|L to low-variant products to ensure collection page performance
      if inline_variant_buttons and product.variants.size < 200
        assign inline_variants = product.variants
      else
        assign inline_variant_buttons = false
        assign inline_variants = nil
      endif

      assign selected_variant = product.selected_variant | default: product.variants[0]

      if preload
        assign preload_variant = true
      endif
      if eagerload
        assign eagerload_variant = true
      endif
    -%}

    {% render 'product-grid-item-variant',
      product: product,
      variant: selected_variant,
      badge_string: badge_string,
      visible: true,
      instant_add_button: instant_add_button,
      inline_variant_buttons: inline_variant_buttons,
      inline_variants: inline_variants,
      section_width: section_width,
      preload: preload_variant,
      eagerload: eagerload_variant,
      placeholder: placeholder,
      columns_desktop: columns_desktop,
      columns_tablet: columns_tablet,
      columns_mobile: columns_mobile
    %}
  {% endif %}

  <div class="product__grid__info {{ text_align | default: settings.collection_text_alignment | default: 'text-center' }}">
    <a
      href="{{ product.url }}" data-grid-link aria-label="{{ product.title | strip_html | escape }}"
      {% comment %} The link wrapping the product variant image is already focusable, so this does not need to be {% endcomment %}
      tabindex="-1"
    >
      <p class="visually-hidden">{{ product.title | strip_html | escape }}</p>

      <div class="product__grid__title__wrapper">
        <p id="product-{{ product.id }}-title" class="product__grid__title">
          {{ product.title | strip_html | escape }}
        </p>
        {%- if settings.product_grid_show_rating and product.metafields.reviews.rating.value != blank -%}
          <div class="rating__wrapper__grid">
            {% render 'product-rating', product: product, show_rating_count: settings.product_grid_show_rating_count %}
          </div>
        {%- endif -%}
      </div>

      <div class="product__grid__price {% if settings.show_cutline %} product__grid__price--nowrap{% endif %}">
        {%- if settings.show_cutline -%}
          <span class="product__grid__cutline">{{ product.metafields.theme.cutline.value }}</span>
        {%- endif -%}
        <span class="price{% if on_sale %} on-sale{% endif %}">
          {% if product.price_varies %}{{ 'products.general.from' | t }} {% endif %}
          {%- if settings.currency_code_enable -%}
            {{ product.price | money_with_currency }}
          {%- else -%}
            {{ product.price | money }}
          {%- endif -%}
        </span>
        {% if on_sale %}
          <span class="compare-at">
            {%- if settings.currency_code_enable -%}
              {{ product.compare_at_price | money_with_currency }}
            {%- else -%}
              {{ product.compare_at_price | money }}
            {%- endif -%}
          </span>
        {% endif %}
      </div>
      {% if product.selected_or_first_available_variant.unit_price %}
        {% capture unit_price_separator %}
          <span aria-hidden="true">/</span><span class="visually-hidden">{{ 'general.accessibility.unit_price_separator' | t }}&nbsp;</span>
        {% endcapture %}
        {% capture unit_price_base_unit %}
          {% if product.selected_or_first_available_variant.unit_price_measurement.reference_value != 1 %}
            {{ product.selected_or_first_available_variant.unit_price_measurement.reference_value }}
          {% endif %}
          {{ product.selected_or_first_available_variant.unit_price_measurement.reference_unit }}
        {% endcapture %}
        <p class="product__grid__price__unit">
          <span class="visually-hidden">{{ 'products.product.unit_price_label' | t }}</span>
          <span class="price-per-unit">
            {%- if settings.currency_code_enable -%}
              {{ product.selected_or_first_available_variant.unit_price | money_with_currency }}
            {%- else -%}
              {{ product.selected_or_first_available_variant.unit_price | money }}
            {%- endif -%}
            {{ unit_price_separator }}{{ unit_price_base_unit }}
          </span>
        </p>
      {% endif %}
      {% if sold_out %}
        <p class="product__grid__price__sold">
          <em>{{ 'products.product.sold_out' | t }}</em>
        </p>
      {% endif %}
    </a>

    {%- if has_siblings -%}
      {%- assign sibs_collection = collections[product.metafields.theme.siblings.value] -%}
      {% if sibs_collection != blank %}
        {%- assign excess_swatches = sibs_collection.products_count | minus: swatch_limit -%}
        <div class="product__grid__sibs">
          <div class="grid__swatch__container">
            <p class="grid__swatch__placeholder">{{ 'collections.general.swatches_with_count' | t: count: sibs_collection.products_count }}</p>
            <div class="grid__swatch__hover">
              <div class="sibs__slider">
                <div class="sibs__inner">
                  {%- for sib_product in visible_siblings -%}
                    {%- assign title_safe = sib_product.title | strip_html | escape -%}
                    {%- assign color_name = sib_product.metafields.theme.cutline.value | default: title_safe -%}
                    <div class="siblings__link__holder {% if sib_product.available == false %} sold-out{% endif %}">
                      <a
                        href="{{ sib_product.url }}"
                        class="siblings__link"
                        data-sibling-swatch-link
                        data-grid-item-variant="{{ sib_product.variants[0].id }}"
                        data-grid-item-swatch-image="0"
                        title="{{ color_name }}"
                        {% if sib_product.handle == product.handle %}aria-current="true"{%- endif -%}
                      >
                        <div class="siblings__swatch">
                          <div class="sibling__image{% if settings.swatches_squares %} sibling__image--square{% endif %}">
                            {% assign image = sib_product.featured_media.preview_image %}
                            {% assign image_width = 26 %}
                            {% assign image_width_2x = image_width | times: 2 | at_most: image.width %}
                            {% assign alt = image.alt | default: color_name %}

                            {% capture srcset %}
                              {{ image | image_url: width: image_width_2x }} 2x,
                              {{ image | image_url: width: image_width }}
                            {% endcapture %}

                            {%- render 'image',
                              img_object: image,
                              wh_ratio: 1.0,
                              srcset: srcset,
                              fetchpriority: 'low',
                              width: image_width,
                              placeholder: placeholder,
                              alt: alt
                            -%}
                          </div>
                        </div>
                      </a>
                    </div>
                  {%- endfor -%}
                  {% if excess_swatches > 0 %} <a class="siblings__more-link" href="{{product.url}}">+{{ excess_swatches }}</a>{% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
      {% endif %}
    {%- elsif has_swatches and swatch_link_markup != '' -%}
      {%- assign excess_swatches = swatch_option.values.size | minus: swatch_limit -%}

      <div class="grid__swatch__container">
        <p class="grid__swatch__placeholder">
          {{ 'collections.general.swatches_with_count' | t: count: swatch_option.values.size }}
        </p>
        <div class="grid__swatch__hover" aria-label="Options">
          {{ swatch_link_markup }} {% if excess_swatches > 0 %}
            <a class="grid__swatch__more-link" href="{{product.url}}">+{{ excess_swatches }}</a>
          {% endif %}
        </div>
      </div>
    {%- endif -%}
  </div>

<!--Custom Code Here--->

  {% liquid
  assign size_option_index = nil

  for option in product.options
    if option == 'Size' or option == 'size'
      assign size_option_index = forloop.index0
      break
    endif
  endfor
%}

{% liquid
  assign size_option_index = nil

  for option in product.options
    if option == 'Size' or option == 'size'
      assign size_option_index = forloop.index0
      break
    endif
  endfor
%}

{% if size_option_index != nil %}
  <div class="product-card-sizes">

    {% assign printed_sizes = '|' %}

    {% for variant in product.variants %}
      {% assign size_value = variant.options[size_option_index] %}
      {% assign size_key = '|' | append: size_value | append: '|' %}

      {% unless printed_sizes contains size_key %}

        {% assign size_available = false %}
        {% assign size_variant_id = nil %}

        {% for v in product.variants %}
          {% if v.options[size_option_index] == size_value %}
            {% assign size_variant_id = v.id %}
            {% if v.available %}
              {% assign size_available = true %}
              {% break %}
            {% endif %}
          {% endif %}
        {% endfor %}

        <button
          type="button"
          class="product-card-size js-add-size"
          data-variant-id="{{ size_variant_id }}"
          {% unless size_available %}disabled{% endunless %}
        >
          {{ size_value }}
        </button>


        {% assign printed_sizes = printed_sizes | append: size_value | append: '|' %}

      {% endunless %}
    {% endfor %}
  </div>
{% endif %}
<script>
document.addEventListener('click', function (event) {
  const btn = event.target.closest('.js-add-size');
  if (!btn) return;

  event.preventDefault();
  event.stopPropagation();

  if (btn.classList.contains('is-loading')) return;

  const variantId = btn.getAttribute('data-variant-id');
  if (!variantId) return;

  btn.classList.add('is-loading');

  fetch('/cart/add.js', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Accept': 'application/json'
    },
    body: JSON.stringify({
      id: Number(variantId),
      quantity: 1
    })
  })
  .then(response => {
    if (!response.ok) throw new Error('Add to cart failed');
    return response.json();
  })
  .then(() => {
    // Pipeline-safe redirect
    window.location.href = '/cart';
  })
  .catch(() => {
    alert('Please try again');
  })
  .finally(() => {
    btn.classList.remove('is-loading');
  });
});
</script>



</product-grid-item>
 {% endcomment %}
{%- liquid
  assign on_sale = false
  if product.compare_at_price > product.price
    assign on_sale = true
  endif

  # We target the first variant for the "Quick Add" button
  assign first_variant = product.selected_or_first_available_variant
-%}

<product-grid-item
  class="product-grid-item group/product-grid-item"
  data-item-id="{{ product.id }}"
  style="position: relative; display: block;"
>
  
  {% comment %} --- 1. IMAGE AREA --- {% endcomment %}
  <div class="product-grid-item__image-container" style="position: relative; overflow: hidden;">
    
    {% comment %} Renders the main product image {% endcomment %}
    {% render 'product-grid-item-variant',
      product: product,
      variant: first_variant,
      visible: true
    %}

    {% comment %} 
      ADD TO CART OVERLAY (Shopping Bag Icon)
      We use a custom class to bypass the theme's Quick View side-drawer.
    {% endcomment %}
    {% if first_variant.available %}
      <div class="custom-cart-icon-overlay">
        <button 
          type="button" 
          class="js-top-bar-add" 
          data-variant-id="{{ first_variant.id }}"
          aria-label="Add to cart"
        >
          <svg aria-hidden="true" focusable="false" role="presentation" class="icon icon-bag" viewBox="0 0 64 64" style="width:22px; height:22px; fill:none; stroke:#000; stroke-width:2px;"><path d="M49.33 18.29H14.67a1 1 0 0 0-1 1.09l2 25.12a4.45 4.45 0 0 0 4.43 4.1h27.8a4.45 4.45 0 0 0 4.43-4.1l2-25.12a1 1 0 0 0-1-1.09Zm-30.83 2h27l-1.76 22.12a2.45 2.45 0 0 1-2.43 2.27H22.7a2.45 2.45 0 0 1-2.43-2.27Zm13.5-9.31a8 8 0 0 0-8 8h2a6 6 0 1 1 12 0h2a8 8 0 0 0-8-8Z"/></svg>
        </button>
      </div>
    {% endif %}
  </div>

  {% comment %} --- 2. PRODUCT INFO --- {% endcomment %}
  <div class="product__grid__info text-center" style="margin-top: 12px;">
    <a href="{{ product.url }}" style="text-decoration: none; color: inherit;">
      <p class="product__grid__title" style="margin: 0; font-size: 13px; text-transform: uppercase;">{{ product.title }}</p>
      <div class="product__grid__price" style="margin-top: 5px; font-weight: bold;">
        <span>{{ product.price | money }}</span>
      </div>
    </a>
  </div>

  {% comment %} --- 3. SIZE BUTTONS (READY TO WEAR) --- {% endcomment %}
  {% liquid
    assign size_option_index = nil
    for option in product.options
      if option == 'Size' or option == 'size'
        assign size_option_index = forloop.index0
        break
      endif
    endfor
  %}

  {% if size_option_index != nil %}
    <div class="product-card-sizes" style="display: flex; justify-content: center; gap: 6px; margin-top: 10px;">
      {% assign printed_sizes = '|' %}
      {% for variant in product.variants %}
        {% assign size_val = variant.options[size_option_index] %}
        {% assign size_key = '|' | append: size_val | append: '|' %}
        {% unless printed_sizes contains size_key %}
          <button 
            type="button" 
            class="product-card-size js-top-bar-add" 
            data-variant-id="{{ variant.id }}" 
            {% unless variant.available %}disabled style="opacity:0.4;"{% endunless %}
          >
            {{ size_val }}
          </button>
          {% assign printed_sizes = printed_sizes | append: size_val | append: '|' %}
        {% endunless %}
      {% endfor %}
    </div>
  {% endif %}

  <style>
    /* Positions the bag icon on the image */
    .custom-cart-icon-overlay {
      position: absolute;
      top: 12px;
      right: 12px;
      z-index: 100;
      opacity: 0;
      transition: all 0.2s ease;
    }
    .product-grid-item:hover .custom-cart-icon-overlay {
      opacity: 1;
    }
    .js-top-bar-add {
      background: #fff;
      border: 1px solid #eee;
      padding: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .product-card-size {
      background: #fff;
      border: 1px solid #e8e8e8;
      padding: 5px 10px;
      font-size: 11px;
      cursor: pointer;
      min-width: 35px;
    }
    .js-top-bar-add.is-loading { opacity: 0.5; cursor: wait; }
  </style>

  <script>
    (function() {
      // Logic for adding to cart and showing the TOP BAR notification
      document.addEventListener('click', function(e) {
        const btn = e.target.closest('.js-top-bar-add');
        if (!btn || btn.classList.contains('is-loading')) return;

        e.preventDefault();
        e.stopPropagation(); // CRITICAL: This stops the theme side-drawer from opening
        
        btn.classList.add('is-loading');
        const variantId = btn.getAttribute('data-variant-id');

        fetch('/cart/add.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
          body: JSON.stringify({ id: Number(variantId), quantity: 1 })
        })
        .then(res => res.json())
        .then(item => {
          // This event tells the theme to show the TOP "Added to Cart" bar
          document.dispatchEvent(new CustomEvent('cart:build', {
            detail: { item: item }
          }));
          
          // Refresh other cart components without opening the drawer
          document.dispatchEvent(new CustomEvent('ajax-cart:refresh'));
        })
        .catch(err => console.error('Cart Error:', err))
        .finally(() => btn.classList.remove('is-loading'));
      });
    })();
  </script>
</product-grid-item>