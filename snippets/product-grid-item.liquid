{% comment %} 
  {%- liquid
  assign on_sale = false
  if product.compare_at_price > product.price
    assign on_sale = true
  endif

  assign sold_out = true
  if product.available
    assign sold_out = false
  endif

  # Siblings are a collection metafield called theme.siblings
  assign sibs_collection = nil
  assign has_siblings = false
  if settings.show_siblings and product.metafields.theme.siblings.value != blank and product.metafields.theme.siblings.type == 'single_line_text_field'
    assign sibs_collection = collections[product.metafields.theme.siblings.value]
    # Ensure the collection was set up to contain this product
    for sib_product in sibs_collection.products
      if sib_product == product
        assign has_siblings = true
      endif
    endfor
  endif

  assign swatch_option = nil
  assign has_swatches = false
  assign swatch_limit = settings.card_swatch_limit

  if settings.swatches_enable and settings.swatches_collection_enable
    # Detect new swatch system
    for option in product.options_with_values
      if option.values.first.swatch != null
        assign has_swatches = true
        assign swatch_option = option
        break
      endif
    endfor

    if has_swatches == false
      # Detect old swatch system
      assign swatch_translation = 'general.swatches.color' | t
      assign swatch_labels = swatch_translation | append: ',' | split: ','
      for label in swatch_labels
        assign sanitized_label = label | lstrip | rstrip
        if product.options_by_name[sanitized_label].values.size > 0
          assign has_swatches = true
          assign swatch_option = product.options_by_name[sanitized_label]
          break
        endif
      endfor
    endif
  endif

  # A button that will add to cart immediately
  assign instant_add_button = nil
  if settings.instant_add_enable
    if product.variants.size == 1
      assign instant_add_button = true
    elsif has_swatches and product.options.size == 1
      assign instant_add_button = true
    endif
  endif

  assign inline_variant_buttons = nil
  if settings.instant_add_enable
    if product.options.size == 1
      assign inline_variant_buttons = product.options_with_values[0]
    elsif has_swatches and product.options.size == 2
      if swatch_option.position == 1
        assign inline_variant_buttons = product.options_with_values[1]
      else
        assign inline_variant_buttons = product.options_with_values[0]
      endif
    endif
  endif

  assign swatch_link_markup = ''
  assign inline_variants = nil
  assign placeholder = placeholder | default: false
  -%}

  <product-grid-item
    aria-label="{{ product.title | strip_html | escape }}"
    class="product-grid-item group/product-grid-item"
    data-item-id="{{ product.id }}"
    {{ attributes }}
  >
    {% if has_siblings and sibs_collection.products.size > 0 %}
      {%- liquid
        assign visible_siblings = "" | split: ","
        assign visible_sibling_count = 1

        for sibling in sibs_collection.products
          if sibling.id == product.id or visible_sibling_count < swatch_limit
            assign new_array = sibling | sort
            assign visible_siblings = visible_siblings | concat: new_array
            unless sibling.id == product.id
              assign visible_sibling_count = visible_sibling_count | plus: 1
            endunless
          endif
        endfor
      -%}

      {%- for sib_product in visible_siblings -%}
        {% liquid
          assign visible = false
          assign first_sibling_variant = sib_product.variants[0]
          if sib_product.id == product.id
            assign visible = true
          endif

          if visible and preload
            assign preload_variant = true
          endif
          if visible and eagerload
            assign eagerload_variant = true
          endif

          assign inline_variant_buttons = nil
          if settings.instant_add_enable and sib_product.options.size == 1
            assign inline_variant_buttons = sib_product.options_with_values[0]
          endif

          if inline_variant_buttons
            assign inline_variants = sib_product.variants
          endif
        -%}

        {% render 'product-grid-item-variant',
          product: sib_product,
          variant: first_sibling_variant,
          badge_string: badge_string,
          visible: visible,
          instant_add_button: instant_add_button,
          inline_variant_buttons: inline_variant_buttons,
          inline_variants: inline_variants,
          section_width: section_width,
          eagerload: eagerload_variant,
          preload: preload_variant,
          placeholder: placeholder,
          columns_desktop: columns_desktop,
          columns_tablet: columns_tablet,
          columns_mobile: columns_mobile
        %}
      {% endfor %}
    {% elsif has_swatches %}
      {%- liquid
        assign swatch_position_key = 'option' | append: swatch_option.position
        assign selected_swatch_value = swatch_option.selected_value
        assign visible_swatches = "" | split: ","

        if selected_swatch_value != blank
          assign visible_swatch_count = 1
        else
          assign visible_swatch_count = 0
        endif

        for swatch_value in swatch_option.values
          if swatch_value == selected_swatch_value or visible_swatch_count < swatch_limit
            assign new_array = swatch_value | sort
            assign visible_swatches = visible_swatches | concat: new_array
            unless swatch_value == selected_swatch_value
              assign visible_swatch_count = visible_swatch_count | plus: 1
            endunless
          endif
        endfor
      -%}

      {%- for swatch_value in visible_swatches -%}
        {% liquid
          if product.variants.size < 200
            assign this_color_variants = product.variants | where: swatch_position_key, swatch_value
            assign in_stock_options = this_color_variants | where: 'available'
            if inline_variant_buttons
              assign inline_variants = this_color_variants
            endif
          else
            assign inline_variant_buttons = false
            assign inline_variants = nil
          endif

          assign current_variant = swatch_value.variant
          if current_variant == blank
            assign current_variant = this_color_variants | first
          endif

          assign visible = false
          if product.selected_variant != blank
            if product.selected_variant.id == current_variant.id
              assign visible = true
            endif
          elsif forloop.first
            assign visible = true
          endif

          if visible and preload
            assign preload_variant = true
          endif
          if visible and eagerload
            assign eagerload_variant = true
          endif
        -%}

        {% render 'product-grid-item-variant',
          product: product,
          variant: current_variant,
          badge_string: badge_string,
          visible: visible,
          instant_add_button: instant_add_button,
          inline_variant_buttons: inline_variant_buttons,
          inline_variants: inline_variants,
          section_width: section_width,
          swatch_option: swatch_option,
          eagerload: eagerload_variant,
          preload: preload_variant,
          placeholder: placeholder,
          columns_desktop: columns_desktop,
          columns_tablet: columns_tablet,
          columns_mobile: columns_mobile
        %}

        {% capture swatch_link_markup %}
          {{ swatch_link_markup }}
          <radio-swatch title="{{ swatch_value.name }}" class="swatch__button{% if in_stock_options.size == 0 %} sold-out{% endif %}{% if settings.swatches_squares %} swatch__button--square{% endif %}">
            <a
              href="{{ current_variant.url }}"
              class="swatch__label"
              {% if swatch_value.swatch != null %}
                data-swatch
                style="--swatch: {{ swatch_value.swatch.color }}"
              {% else %}
                data-swatch="{{ swatch_value | escape_once }}"
              {% endif %}
              data-grid-item-variant="{{ current_variant.id }}"
              data-swatch-index="{{ forloop.index0 }}"
              {% if visible %}aria-current="true"{%- endif -%}
              {% if current_variant.featured_media %}
                data-swatch-image="{{ current_variant.featured_media.preview_image.src }}"
                data-swatch-image-id="{{ current_variant.featured_media.id }}"
              {% endif %}
            >
              {% if swatch_value.swatch.image %}
                {% render 'image', img_object: swatch_value.swatch.image, width: 34, wh_ratio: 1 %}
              {% endif %}
              <span class="visually-hidden">{{ swatch_value }}</span>
            </a>
          </radio-swatch>
        {% endcapture %}
      {% endfor %}
    {% else %}
      {%- liquid
        if inline_variant_buttons and product.variants.size < 200
          assign inline_variants = product.variants
        else
          assign inline_variant_buttons = false
          assign inline_variants = nil
        endif

        assign selected_variant = product.selected_variant | default: product.variants[0]
        if preload
          assign preload_variant = true
        endif
        if eagerload
          assign eagerload_variant = true
        endif
      -%}

      {% render 'product-grid-item-variant',
        product: product,
        variant: selected_variant,
        badge_string: badge_string,
        visible: true,
        instant_add_button: instant_add_button,
        inline_variant_buttons: inline_variant_buttons,
        inline_variants: inline_variants,
        section_width: section_width,
        preload: preload_variant,
        eagerload: eagerload_variant,
        placeholder: placeholder,
        columns_desktop: columns_desktop,
        columns_tablet: columns_tablet,
        columns_mobile: columns_mobile
      %}
    {% endif %}

    <div class="product__grid__info {{ text_align | default: settings.collection_text_alignment | default: 'text-left' }}">
      <a href="{{ product.url }}" data-grid-link aria-label="{{ product.title | strip_html | escape }}" tabindex="-1">
        <p class="visually-hidden">{{ product.title | strip_html | escape }}</p>

        <div class="product__grid__title__wrapper">
          <p id="product-{{ product.id }}-title" class="product__grid__title">
            {{ product.title | strip_html | escape }}
          </p>
          {%- if settings.product_grid_show_rating and product.metafields.reviews.rating.value != blank -%}
            <div class="rating__wrapper__grid">
              {% render 'product-rating', product: product, show_rating_count: settings.product_grid_show_rating_count %}
            </div>
          {%- endif -%}
        </div>

        <div class="product__grid__price {% if settings.show_cutline %} product__grid__price--nowrap{% endif %}">
          {%- if settings.show_cutline -%}
            <span class="product__grid__cutline">{{ product.metafields.theme.cutline.value }}</span>
          {%- endif -%}
          <span class="price{% if on_sale %} on-sale{% endif %}">
            {% if product.price_varies %}{{ 'products.general.from' | t }} {% endif %}
            {%- if settings.currency_code_enable -%}
              {{ product.price | money_with_currency }}
            {%- else -%}
              {{ product.price | money }}
            {%- endif -%}
          </span>
          {% if on_sale %}
            <span class="compare-at">
              {%- if settings.currency_code_enable -%}
                {{ product.compare_at_price | money_with_currency }}
              {%- else -%}
                {{ product.compare_at_price | money }}
              {%- endif -%}
            </span>
          {% endif %}
        </div>
      </a>

      {%- if has_siblings -%}
        {%- assign sibs_collection = collections[product.metafields.theme.siblings.value] -%}
        {% if sibs_collection != blank %}
          {%- assign excess_swatches = sibs_collection.products_count | minus: swatch_limit -%}
          <div class="product__grid__sibs">
            <div class="grid__swatch__container">
              <p class="grid__swatch__placeholder">{{ 'collections.general.swatches_with_count' | t: count: sibs_collection.products_count }}</p>
              <div class="grid__swatch__hover">
                <div class="sibs__slider">
                  <div class="sibs__inner">
                    {%- for sib_product in visible_siblings -%}
                      {%- assign title_safe = sib_product.title | strip_html | escape -%}
                      {%- assign color_name = sib_product.metafields.theme.cutline.value | default: title_safe -%}
                      <div class="siblings__link__holder {% if sib_product.available == false %} sold-out{% endif %}">
                        <a href="{{ sib_product.url }}" class="siblings__link" data-sibling-swatch-link data-grid-item-variant="{{ sib_product.variants[0].id }}" data-grid-item-swatch-image="0" title="{{ color_name }}" {% if sib_product.handle == product.handle %}aria-current="true"{%- endif -%}>
                          <div class="siblings__swatch">
                            <div class="sibling__image{% if settings.swatches_squares %} sibling__image--square{% endif %}">
                              {% assign image = sib_product.featured_media.preview_image %}
                              {% assign image_width = 26 %}
                              {% assign image_width_2x = image_width | times: 2 | at_most: image.width %}
                              {% capture srcset %}{{ image | image_url: width: image_width_2x }} 2x, {{ image | image_url: width: image_width }}{% endcapture %}
                              {%- render 'image', img_object: image, wh_ratio: 1.0, srcset: srcset, width: image_width, alt: color_name -%}
                            </div>
                          </div>
                        </a>
                      </div>
                    {%- endfor -%}
                    {% if excess_swatches > 0 %} <a class="siblings__more-link" href="{{product.url}}">+{{ excess_swatches }}</a>{% endif %}
                  </div>
                </div>
              </div>
            </div>
          </div>
        {% endif %}
      {%- elsif has_swatches and swatch_link_markup != '' -%}
        {%- assign excess_swatches = swatch_option.values.size | minus: swatch_limit -%}
        <div class="grid__swatch__container">
          <p class="grid__swatch__placeholder">{{ 'collections.general.swatches_with_count' | t: count: swatch_option.values.size }}</p>
          <div class="grid__swatch__hover" aria-label="Options">
            {{ swatch_link_markup }}
            {% if excess_swatches > 0 %}
              <a class="grid__swatch__more-link" href="{{product.url}}">+{{ excess_swatches }}</a>
            {% endif %}
          </div>
        </div>
      {%- endif -%}
    </div>

    {% liquid
      assign size_option_index = nil
      for option in product.options
        if option == 'Size' or option == 'size'
          assign size_option_index = forloop.index0
          break
        endif
      endfor
    %}

    {% if size_option_index != nil %}
      {% liquid
        assign check_unstitch = product.variants[0].options[size_option_index] | downcase
      %}

      {% unless check_unstitch contains 'unstitch' %}
        <div class="product-card-sizes">
          {% assign printed_sizes = '|' %}
          {% for variant in product.variants %}
            {% assign size_value = variant.options[size_option_index] %}
            {% assign size_key = '|' | append: size_value | append: '|' %}

            {% unless printed_sizes contains size_key %}
              {% assign size_available = false %}
              {% assign size_variant_id = nil %}

              {% for v in product.variants %}
                {% if v.options[size_option_index] == size_value %}
                  {% assign size_variant_id = v.id %}
                  {% if v.available %}
                    {% assign size_available = true %}
                    {% break %}
                  {% endif %}
                {% endif %}
              {% endfor %}

              <button type="button" class="product-card-size js-add-size" data-variant-id="{{ size_variant_id }}" {% unless size_available %}disabled{% endunless %}>
                {{ size_value }}
              </button>
              {% assign printed_sizes = printed_sizes | append: size_value | append: '|' %}
            {% endunless %}
          {% endfor %}
        </div>
      {% endunless %}
    {% endif %}

    <script>
      document.addEventListener('click', function (event) {
        const btn = event.target.closest('.js-add-size');
        if (!btn) return;
        event.preventDefault();
        event.stopPropagation();
        if (btn.classList.contains('is-loading')) return;
        const variantId = btn.getAttribute('data-variant-id');
        if (!variantId) return;
        btn.classList.add('is-loading');
        fetch('/cart/add.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
          body: JSON.stringify({ id: Number(variantId), quantity: 1 })
        })
        .then(response => {
          if (!response.ok) throw new Error('Add to cart failed');
          return response.json();
        })
        .then(() => { window.location.href = '/cart'; })
        .catch(() => { alert('Please try again'); })
        .finally(() => { btn.classList.remove('is-loading'); });
      });
    </script>
  </product-grid-item>
 {% endcomment %}



{%- liquid
assign on_sale = false
if product.compare_at_price > product.price
  assign on_sale = true
endif

assign first_available_variant = product.selected_or_first_available_variant

# Swatch and Siblings logic (Standard theme setup)
assign has_swatches = false
if settings.swatches_enable and settings.swatches_collection_enable
  for option in product.options_with_values
    if option.values.first.swatch != null
      assign has_swatches = true
      break
    endif
  endfor
endif

assign instant_add_button = nil
if settings.instant_add_enable and product.available
  assign instant_add_button = true
endif
-%}

<product-grid-item
  class="product-grid-item group/product-grid-item"
  data-item-id="{{ product.id }}"
  {{ attributes }}
>
  {% comment %} --- 1. CLICKABLE IMAGE --- {% endcomment %}
  <a href="{{ product.url }}" class="product-grid-item__image-link" style="display: block;">
    {% render 'product-grid-item-variant',
      product: product,
      variant: first_available_variant,
      badge_string: badge_string,
      visible: true,
      instant_add_button: instant_add_button,
      section_width: section_width,
      eagerload: eagerload,
      preload: preload,
      placeholder: placeholder,
      columns_desktop: columns_desktop,
      columns_tablet: columns_tablet,
      columns_mobile: columns_mobile
    %}
  </a>

  <div class="product__grid__info {{ text_align | default: settings.collection_text_alignment | default: 'text-left' }}">
    <a href="{{ product.url }}">
      <div class="product__grid__title__wrapper">
        <p class="product__grid__title">{{ product.title | strip_html | escape }}</p>
      </div>
      <div class="product__grid__price">
        <span class="price{% if on_sale %} on-sale{% endif %}">
          {{ product.price | money }}
        </span>
        {% if on_sale %}<span class="compare-at">{{ product.compare_at_price | money }}</span>{% endif %}
      </div>
    </a>
  </div>

  {% comment %} --- 2. SIZES SECTION --- {% endcomment %}
  {% liquid
    assign size_option_index = nil
    for option in product.options
      assign down-option = option | downcase
      if down-option == 'size'
        assign size_option_index = forloop.index0
        break
      endif
    endfor
  %}

  {% if size_option_index != nil %}
    <div class="product-card-sizes" style="display: flex; gap: 6px; margin-top: 10px; flex-wrap: wrap;">
      {% assign printed_sizes = '' %}
      {% for variant in product.variants %}
        {% assign size_value = variant.options[size_option_index] %}
        {% unless printed_sizes contains size_value %}
          <button 
            type="button" 
            class="js-grid-size-btn" 
            data-variant-id="{{ variant.id }}"
            style="border: 1px solid #000; padding: 4px 8px; font-size: 11px; background: #fff; color: #000; cursor: pointer; text-transform: uppercase; {% unless variant.available %}opacity: 0.3; text-decoration: line-through; cursor: not-allowed;{% endunless %}"
            {% unless variant.available %}disabled{% endunless %}
          >
            {{ size_value }}
          </button>
          {% assign printed_sizes = printed_sizes | append: size_value | append: ',' %}
        {% endunless %}
      {% endfor %}
    </div>
  {% endif %}

  <style>
    .js-grid-size-btn.is-active { background: #000 !important; color: #fff !important; }
    .product-grid-item { position: relative; }
  </style>

  <script>
    (function() {
      const container = document.querySelector('[data-item-id="{{ product.id }}"]');
      if (!container) return;

      // Default selection is the first available variant
      let activeVariantId = "{{ first_available_variant.id }}";

      container.addEventListener('click', function(e) {
        const sizeBtn = e.target.closest('.js-grid-size-btn');
        const bagBtn = e.target.closest('.quick-action-button') || e.target.closest('[data-variant-id]:not(.js-grid-size-btn)');

        // Handle Size Selection
        if (sizeBtn) {
          e.preventDefault();
          e.stopPropagation();
          
          activeVariantId = sizeBtn.getAttribute('data-variant-id');

          // UI Toggle
          container.querySelectorAll('.js-grid-size-btn').forEach(b => b.classList.remove('is-active'));
          sizeBtn.classList.add('is-active');

          // Force "Bag" button to recognize this new ID
          const realBag = container.querySelector('.quick-action-button');
          if (realBag) {
            realBag.setAttribute('data-variant-id', activeVariantId);
          }
          
          // Optional: Add to cart immediately on size click
          // remove the line below if you ONLY want the bag button to add to cart
          handleCartAdd(activeVariantId, sizeBtn);
        } 
        
        // Handle Bag Button Click
        else if (bagBtn) {
          e.preventDefault();
          e.stopPropagation();
          handleCartAdd(activeVariantId, bagBtn);
        }
      }, true);

      function handleCartAdd(id, trigger) {
        if (trigger.classList.contains('is-loading')) return;
        trigger.classList.add('is-loading');

        fetch('/cart/add.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: Number(id), quantity: 1 })
        })
        .then(res => res.json())
        .then(data => {
          // Trigger theme events for cart drawer/notification
          document.dispatchEvent(new CustomEvent('ajaxProduct:added', {
            detail: { product: data, variantId: id }
          }));
          document.dispatchEvent(new CustomEvent('cart:refresh', { bubbles: true }));
        })
        .catch(err => console.error('Error adding to cart', err))
        .finally(() => trigger.classList.remove('is-loading'));
      }
    })();
  </script>
</product-grid-item>