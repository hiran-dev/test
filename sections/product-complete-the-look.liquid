{% assign complete_products = product.metafields.custom.frequently_bought.value %}

{% if complete_products and complete_products.size > 0 %}
<section class="complete-the-look">
  <div class="page-width">

    <h3 class="complete-the-look-title">Complete the Look</h3>

    <div class="complete-the-look-grid">

      {% for item in complete_products %}
        {% assign image = nil %}
        {% if item.featured_media %}
          {% assign image = item.featured_media.preview_image %}
        {% elsif item.media.size > 0 %}
          {% assign image = item.media.first.preview_image %}
        {% endif %}

        <div class="complete-look-item">
          <div class="complete-look-img">	
            {% if image %}
              <a href="{{ item.url }}">
                <img src="{{ image | image_url: width:300 }}" alt="{{ item.title }}">
              </a>
            {% endif %}
          </div>

          <div class="inline-info-flex">
            <div class="inline-info inlbox">
              <p class="complete-look-product-title">{{ item.title }}</p>
              {% assign first_variant = item.selected_or_first_available_variant %}
              {% if first_variant %}
                <p class="complete-look-product-price">{{ first_variant.price | money }}</p>
              {% endif %}
            </div>

            <div class="inline-info-buttons inlbox">
              {% assign size_variants = item.variants | where: "available", true %}
              {% if size_variants.size > 0 %}
                <div class="complete-look-form">

                  <input type="hidden" name="id" value="{{ first_variant.id }}" class="complete-look-selected-variant">

                  <div class="complete-look-size-btn-item">
                    {% for variant in size_variants %}
                      {% assign size_value = variant.options[0] %}
                      <button type="button" class="complete-look-size-btn" data-variant-id="{{ variant.id }}">
                        {{ size_value }}
                      </button>
                    {% endfor %}
                  </div>

                  <!-- Add to Cart Button -->
                  <button type="button" class="complete-look-add-cart-btn">
                    Add to Cart
                  </button>

                </div>
              {% endif %}
            </div>
          </div>

        </div>
      {% endfor %}

    </div>

  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {

  // Handle size selection
  const sizeButtons = document.querySelectorAll('.complete-look-size-btn');
  sizeButtons.forEach(button => {
    button.addEventListener('click', function() {
      const form = button.closest('.complete-look-form');
      const hiddenInput = form.querySelector('.complete-look-selected-variant');
      hiddenInput.value = button.dataset.variantId;

      // Highlight selected size
      form.querySelectorAll('.complete-look-size-btn').forEach(b => b.classList.remove('selected'));
      button.classList.add('selected');
    });
  });

  // Handle AJAX Add to Cart
  const addToCartButtons = document.querySelectorAll('.complete-look-add-cart-btn');
  addToCartButtons.forEach(button => {
    button.addEventListener('click', function(e) {
      e.preventDefault(); // Prevent page refresh

      const form = button.closest('.complete-look-form');
      const variantId = form.querySelector('.complete-look-selected-variant').value;

      // Disable button temporarily
      button.disabled = true;
      const originalText = button.textContent;
      button.textContent = 'Adding...';

      fetch('/cart/add.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify({ id: variantId, quantity: 1 })
      })
      .then(res => res.json())
      .then(data => {
        // Fetch updated cart
        return fetch('/cart.js');
      })
      .then(res => res.json())
      .then(cart => {
        // Update Pipeline Flycart
        if (window.Pipeline && window.Pipeline.FlyCart) {
          window.Pipeline.FlyCart.updateCart(cart);
          window.Pipeline.FlyCart.open();
        }

        // Show Added text
        button.textContent = 'Added!';
        setTimeout(() => {
          button.textContent = originalText;
          button.disabled = false;
        }, 2000);
      })
      .catch(err => {
        console.error('Add to cart error:', err);
        button.textContent = 'Error';
        setTimeout(() => {
          button.textContent = originalText;
          button.disabled = false;
        }, 2000);
      });
    });
  });

});
</script>
{% endif %}



<style>
.complete-the-look {
    max-width: 500px;
}
.complete-look-item {
    display: flex;
    gap: 20px;
    padding: 10px;
    justify-content: flex-start;
    border: 1px solid rgb(224, 221, 221);
    border-radius: 3px;
	margin: 0 0 10px;
} 
.complete-look-img {
    width: 20%;
    max-width: 80px;
}
h3.complete-the-look-title {
    font-size: 18px;
    color: #000;
    letter-spacing: 0;
    font-weight: 600;
}
.complete-look-product-title {
    font-size: 14px;
    margin: 0 0 5px;
    letter-spacing: 0;
}
.complete-look-product-price {
    margin: 5px 0 10px 0;
    display: block;
}
.complete-look-size-btn {
    padding: 7px 12px;
    border: 0;
    border-radius: 4px;
    background: #f8f8f8;
    cursor: pointer;
    font-size: 12px;
}
button.complete-look-size-btn.selected {
	background: #111;
    color: #fff;
}
button.complete-look-add-cart-btn {
    width: 20%;
    max-width: 60px;
    background-color: #545454;
    color: #fff;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    padding: 21px;
    line-height: 0;
    min-height: 0;
    height: 60px;
    text-align: center;
}
.inline-info-flex {
    width: 80%;
}
.complete-look-form {
    display: flex;
    justify-content: space-between;
    align-items: center;
} 
</style>



{% schema %}
{
  "name": "Complete the Look",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Complete the Look"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button Text",
      "default": "Add Selected to Cart"
    }
  ],
  "presets": [
    {
      "name": "Complete the Look"
    }
  ]
}
{% endschema %}
