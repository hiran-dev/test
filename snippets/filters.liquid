{%- liquid
  # Pre-calculate common variables once to save processing time
  assign limit = 10
  assign is_image_option = false
  if filter.presentation == 'image'
    assign is_image_option = true
  endif

  # Determine accordion state once
  assign accordion_open = false
  if filter.active_values.size > 0 or filter.min_value.value > 0
    assign accordion_open = true
  elsif filter.max_value.value < filter.range_max
    assign accordion_open = true
  endif

  if accordion_open
    assign accordion_class = 'accordion-is-open'
  endif
-%}

<div class="sidebar__filter__group" {% if block %}{{ block.shopify_attributes }}{% endif %}>
  {%- comment -%} Optimized Heading: Fast toggle {%- endcomment -%}
  <button class="sidebar__heading js {{ accordion_class }}"
    data-accordion-trigger="accordion-{{ filter.label | handle }}-{{ forloop.index }}"
    aria-controls="accordion-{{ filter.label | handle }}-{{ forloop.index }}"
    aria-expanded="{{ accordion_open }}">
    <span>{{ filter.label }}</span>
    {%- if filter.active_values.size > 0 -%}
      <span class="ml-1">({{ filter.active_values.size }})</span>
    {%- endif -%}
    <span class="sidebar__heading-chevron">
      {% render 'icon-core-chevron-right' %}
    </span>
  </button>

  <input type="checkbox" id="accordion-{{ filter.label | handle }}-checkbox" class="no-js no-js-checkbox" checked>

  {%- case filter.type -%}
    {%- when 'list' or 'boolean' -%}
      <ul class="sidebar__navigation__list" 
          id="accordion-{{ filter.label | handle }}-{{ forloop.index }}" 
          data-accordion-body 
          {% unless accordion_open %}style="display: none;"{% endunless %}>
        
        {%- for filter_value in filter.values -%}
          {%- capture input_id -%}f-{{ filter.label | handleize }}-{{ forloop.index }}{%- endcapture -%}
          <li class="filter__button {% if forloop.index > limit %} is-hidden{% endif %}" data-option-holder>
            <input type="checkbox"
              name="{{ filter_value.param_name }}"
              value="{{ filter_value.value }}"
              id="{{ input_id }}"
              style="display: block !important; opacity: 1 !important; visibility: visible !important;"
              {% if filter_value.active %}checked{% endif %}
              {% if filter_value.count == 0 and filter_value.active == false %}disabled{% endif %}>
            
            <label class="stateful-filter-icons" for="{{ input_id }}">
              {%- if is_image_option and filter_value.image -%}
                <span class="max-w-[140px]">
                  {%- render 'image' img_object: filter_value.image, width: 140, wh_ratio: filter_value.image.aspect_ratio -%}
                </span>
              {%- else -%}
                {{ filter_value.label | escape }}
              {%- endif -%}
              {% render 'icon-stateful-box' %}
            </label>
          </li>
        {%- endfor -%}
      </ul>

      {% if filter.values.size > limit %}
        <button type="button" data-show-more class="mt-2 text-sm underline">{{ 'collections.sidebar.show_more' | t }}</button>
      {% endif %}

    {%- when 'price_range' -%}
      <div class="sidebar__navigation__list filter__price" 
           id="accordion-{{ filter.label | handle }}-{{ forloop.index }}" 
           data-accordion-body 
           {% unless accordion_open %}style="display: none;"{% endunless %}>
        
        {%- liquid
          # Efficient price math
          assign raw_max = filter.range_max | money_without_currency
          if shop.money_format contains "comma_separator" or shop.money_format contains "space_separator"
            assign max_val = raw_max | replace: ' ', '' | replace: '.', '' | replace: ',', '.' | ceil
          else
            assign max_val = raw_max | replace: ',', '' | ceil
          endif

          assign current_min = 0
          if filter.min_value.value
             assign current_min = filter.min_value.value | money_without_currency | replace: ',', '' | floor
          endif

          assign current_max = max_val
          if filter.max_value.value
             assign current_max = filter.max_value.value | money_without_currency | replace: ',', '' | floor
          endif
        -%}

        <div class="filter__price__range collection-range-filter" 
             data-range-slider data-range-filter-update 
             data-se-min="0" data-se-step="1" 
             data-se-min-value="{{ current_min }}" 
             data-se-max-value="{{ current_max }}" 
             data-se-max="{{ max_val }}">
          <div class="range__dot range__dot--left" data-range-left><span></span></div>
          <div class="range__dot range__dot--right" data-range-right><span></span></div>
          <div class="range__line"><span data-range-line></span></div>
        </div>

        <div class="filter__price__fields flex items-center justify-between mt-4">
          <div class="filter__price__field">
            <span class="text-xs opacity-70">{{ cart.currency.symbol }}</span>
            <input data-field-price-min class="filter__price__input" name="{{ filter.min_value.param_name }}" value="{{ current_min }}" type="number" min="0" max="{{ max_val }}">
          </div>
          <div class="px-2">-</div>
          <div class="filter__price__field">
            <span class="text-xs opacity-70">{{ cart.currency.symbol }}</span>
            <input data-field-price-max class="filter__price__input" name="{{ filter.max_value.param_name }}" value="{{ current_max }}" type="number" min="0" max="{{ max_val }}">
          </div>
        </div>
      </div>
  {%- endcase -%}
</div>